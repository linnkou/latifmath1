document.getElementById('upload-button')?.addEventListener('click', async () => {
    console.log("تم النقر على زر رفع الملف"); // تحقق من ظهور هذه الرسالة في الكونسول

    const year = document.getElementById('year').value;
    const section = document.getElementById('section').value;
    const fileName = document.getElementById('file-name').value.trim();
    const file = document.getElementById('file-upload').files[0];

    console.log("السنة:", year); // تحقق من قيمة السنة
    console.log("القسم:", section); // تحقق من قيمة القسم
    console.log("اسم الملف:", fileName); // تحقق من اسم الملف
    console.log("الملف:", file); // تحقق من الملف

    if (!file) {
        alert('يرجى اختيار ملف.');
        return;
    }

    if (!fileName) {
        alert('يرجى إدخال اسم الملف.');
        return;
    }

    try {
        console.log("جاري رفع الملف...");
        const downloadUrl = await uploadFileToGitHub(file, fileName, year, section);
        console.log("تم رفع الملف بنجاح:", downloadUrl);
        displayFileLink(fileName, downloadUrl);
        alert('تم رفع الملف بنجاح!');
    } catch (error) {
        console.error("حدث خطأ أثناء رفع الملف:", error);
        alert('حدث خطأ أثناء رفع الملف: ' + error.message);
    }
});

async function uploadFileToGitHub(file, fileName, year, section) {
    const token = 'YOUR_FINE_GRAINED_TOKEN'; // استبدل بالرمز الخاص بك
    const repoOwner = 'YOUR_GITHUB_USERNAME'; // استبدل باسم مستخدمك
    const repoName = 'YOUR_REPO_NAME'; // استبدل باسم المستودع
    const path = `${year}/${section}/${fileName}`; // المسار في المستودع

    const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;

    const content = await toBase64(file); // تحويل الملف إلى Base64

    const response = await fetch(url, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: `رفع ملف: ${fileName}`,
            content: content
        })
    });

    if (!response.ok) {
        throw new Error(`خطأ في الرفع: ${response.statusText}`);
    }

    const data = await response.json();
    return data.content.download_url; // رابط التحميل
}

function toBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });
}

function displayFileLink(fileName, downloadUrl) {
    const fileList = document.getElementById('file-list');
    const fileLink = document.createElement('a');
    fileLink.href = downloadUrl;
    fileLink.textContent = fileName;
    fileLink.target = '_blank';
    fileList.appendChild(fileLink);
}
